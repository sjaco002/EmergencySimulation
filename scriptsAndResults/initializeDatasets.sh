#! /bin/sh

#create dataverse and datasets
curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=drop dataverse channels if exists;
create dataverse channels;
use dataverse channels;

create type UserLocation as closed {
	recordId: uuid,
	location: circle,
	userName: string,
	timeStamp: datetime
}
create type EmergencyShelter as closed {
	shelterName: string,
	location: circle
}

create type EmergencyReport as closed {
	reportId: uuid,
	Etype: string,
	location: circle,
	timeStamp: datetime
}

create type PollingResult as open {
	resultId: uuid
}

create dataset UserLocations(UserLocation)
primary key recordId autogenerated;

create dataset EmergencyShelters(EmergencyShelter)
primary key shelterName;

create dataset EmergencyReports(EmergencyReport)
primary key reportId autogenerated;

create dataset PollingResults(PollingResult)
primary key resultId autogenerated;
' http://localhost:19002/aql > reponses/reponses.txt


curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=use dataverse channels;
create feed ReportFeed using socket_adapter
(
    ("sockets"="127.0.0.1:10001"),
    ("address-type"="IP"),
    ("type-name"="EmergencyReport"),
    ("format"="adm")
);
' http://localhost:19002/aql > reponses/reponses.txt

curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=use dataverse channels;
create feed LocationFeed using socket_adapter
(
    ("sockets"="127.0.0.1:10002"),
    ("address-type"="IP"),
    ("type-name"="UserLocation"),
    ("format"="adm")
);
' http://localhost:19002/aql > reponses/reponses.txt

curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=use dataverse channels;
connect feed ReportFeed to dataset EmergencyReports;
' http://localhost:19002/aql > reponses/reponses.txt

curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=use dataverse channels;
connect feed LocationFeed to dataset UserLocations;
' http://localhost:19002/aql > reponses/reponses.txt


curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=use dataverse channels;
start feed LocationFeed;
start feed ReportFeed;
' http://localhost:19002/aql > reponses/reponses.txt

while read p; do
  curl -G -H "Accept: application/x-adm" -v --data-urlencode 'aql=use dataverse channels; insert into dataset EmergencyShelters('"$p"')' http://localhost:19002/aql > reponses/reponses.txt
  echo "p is"$p
done <Shelters.adm